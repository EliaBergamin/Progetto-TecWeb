<!DOCTYPE html>
<html lang="it">

<head>
    <title>Prenotazione</title>
    <meta charset="UTF-8">
    <meta name="description" content="Pagina per prenotare una visita al museo">
    <meta name="keywords" content="museo,prenotazione,visita,disponibilità,giorno,carte,cartoni,biglietto">
    <link rel="stylesheet" href="../css/style.css" media="screen">
    <link rel="stylesheet" href="../css/middle.css" media="screen and (max-width: 1024px)">
    <link rel="stylesheet" href="../css/mini.css" media="screen and (max-width: 768px)">
    <link rel="stylesheet" href="../css/print.css" media="print">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/pokeball.ico" type="image/x-icon">
    <script type="text/javascript" src="../js/script.js"></script>
    <script type="text/javascript" src="../js/regole.js"></script>
    <script type="text/javascript" src="../js/validazione.js"></script>
    <script type="text/javascript" src="../js/validazione-prenotazione.js"></script>
</head>

<body onload="caricamentoValidazione();">
    <a id="top-help" class="help nascosto" href="#primoContenuto">Vai al contenuto</a>
    <header>
        <h1>Museo Cartoni Animati</h1>
        <button id="hamb" class="hamToggle" data-hambOn="false" type="button" onclick="hambToggle()">Menù</button>
    </header>

    <nav id="breadcrumb">
        <p>
            Ti trovi in: <a href="index.php" lang="en">Home</a> &gt; Prenotazione
        </p>
    </nav>

    <nav id="menu" class="hamToggle" data-hambOn="false">
        <ul>
            <li><a href="index.php" lang="en">Home</a></li>
            <li><a href="mostre.php">Le mostre</a></li>
            <li><a href="virtual_tour.php" lang="en">Virtual Tour</a></li>
            <li id="currentLink">Prenotazione</li>
            <li><a href="recensioni.php">Recensioni</a></li>
            <!-- log_start -->
            <li><a href="registrazione.php">Registrati</a></li>
            <li><a href="login.php">Accedi</a></li>
            <!-- log_end -->
            <!-- account_opt_start -->
            <li><a href={{option_link}}>{{option}}</a></li>
            <li><a href="logout.php">Esci</a></li>
            <!-- account_opt_end -->
            <!-- greeting_start -->
            <li><span>Ciao {{username}}!</span></li>
            <!-- greeting_end -->
        </ul>
    </nav>

    <main id="prenotazione" class="compilazione">
        <div id="contenitorePrenotazione" class="contenitoreCompilazione">
            <h1>Prenota la tua visita al museo</h1>
            <form action="prenotazioneEffettuata.php" method="post" id="formPrenotazione" class="formCompilazione">
                <label for="giorno">Giorno</label>
                <!-- da mettere come minimo il giorno odierno -->
                <input type="date" name="giorno" id="giorno" required data-msg-required="Per favore, selezionare il giorno della visita" data-msg-invalid="Giorno non valido">
                <label for="orario">Fascia oraria</label>
                <select name="orario" id="orario" required>
                    <option value="" disabled selected>Seleziona</option>
                    <optgroup label="mattina">
                        <option id="09" value="09">09:00 - 10:30</option>
                        <option id="10_30" value="10_30">10:30 - 12:00</option>
                    </optgroup>
                    <optgroup label="pomeriggio">
                        <option id="12" value="12">12:00 - 13:30</option>
                        <option id="13_30" value="13_30">13:30 - 15:00</option>
                        <option id="15" value="15">15:00 - 16:30</option>
                        <option id="16_30" value="16_30">16:30 - 18:00</option>
                    </optgroup>
                </select>
                <label for="visitatori">Numero di visitatori</label>
                <!-- max 15 valore da decidere -->
                <input type="number" name="visitatori" id="visitatori" min="1" max="15" required data-msg-required="Per favore, selezionare il numero di visitatori" data-msg-invalid="Massimo x visitatori">
                <input type="submit" value="Prenota">
            </form>
        </div>
    </main>
    <a class="help" id="torna-su" href="#">Torna su</a>
    <footer>
        <h2>Museo Cartoni Animati</h2>
        <dl>
            <dt> <abbr title="telefono">Tel</abbr>: </dt>
            <dd><a href="tel:+39123456789">123456789</a> </dd>
            <dt> <span lang="en">Email: </span> </dt>
            <dd> <a href="mailto:info@dominioImmaginario.com">info@dominioImmaginario.comm</a> </dd>
            <dt> Indirizzo: </dt>
            <dd>
                <a href="https://maps.app.goo.gl/xqD3pfvXG4ockxUeA">Via Luigi Luzzatti,
                    <abbr title="Numero civico">n.</abbr> 8, 35121 Padova</a>
            </dd>
        </dl>
        <!--         <a href="" lang="en">Privacy Link TODO</a>
 -->
        <p id="tab-descr" class="nascosto">La tabella contiene gli orari di apertura del museo</p>
        <table id="orari-museo" title="Orari del museo" aria-describedby="tab-descr">
            <caption>Orari del Museo</caption>
            <thead>
                <tr>
                    <td></td>
                    <th scope="col">Mattina</th>
                    <th scope="col">Pomeriggio</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th scope="row">Lunedì</th>
                    <td>09:00 - 12:00</td>
                    <td>14:00 - 19:00</td>
                </tr>
                <tr>
                    <th scope="row">Martedì</th>
                    <td>09:00 - 12:00</td>
                    <td>14:00 - 19:00</td>
                </tr>
                <tr>
                    <th scope="row">Sabato</th>
                    <td>08:00 - 13:00</td>
                    <td>14:00 - 20:00</td>
                </tr>
                <tr>
                    <th scope="row">Domenica</th>
                    <td>08:00 - 13:00</td>
                    <td>14:00 - 22:00</td>
                </tr>
            </tbody>
        </table>
    </footer>
</body>

<script>
    document.getElementById('giorno').addEventListener('change', function () {
        const giornoSelezionato = this.value;

        if (!giornoSelezionato) return;
        fetch('../phplibs/controlla_disponibilita.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `giorno=${encodeURIComponent(giornoSelezionato)}`,
        })
        .then(response => response.json())
        .then(data => {
            aggiornaOrariDisponibili(data);
        })
        .catch(error => {
            console.error('Errore durante il recupero degli slot:', error);
        });
    });

    function aggiornaOrariDisponibili(slotDisponibili) {
        const selectOrario = document.getElementById('orario');

        while (selectOrario.options.length > 1) {
            selectOrario.remove(1);
        }

        const slotIds = ["09","10_30","12","13_30","15","16_30"];

        let hasAvailableSlots = false;

        for (const [orario, postiDisponibili] of Object.entries(slotDisponibili)) {
            if (postiDisponibili > 0) {
                hasAvailableSlots = true;
                const option = document.createElement('option');
                option.value = orario;
                option.textContent = `${slot[orario]} (${postiDisponibili} posti disponibili)`;
                option.dataset.postiDisponibili = postiDisponibili;
                selectOrario.appendChild(option);
            }
        }

        // TODO: intanto mostro un alert, da capire bene come vogliamo fare
        if (!hasAvailableSlots) {
            alert('Nessun slot disponibile per il giorno selezionato.');
        }
    }

    document.getElementById('giorno').addEventListener('change', function () {
        const inputVisitatori = document.getElementById('visitatori');
        const selectedOption = selectOrario.options[selectOrario.selectedIndex];
        const postiDisponibili = selectedOption.dataset.postiDisponibili || 90;
        inputVisitatori.max = postiDisponibili;
        inputVisitatori.value = Math.min(inputVisitatori.value, postiDisponibili);
    });
</script>

</html>